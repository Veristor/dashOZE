name: ğŸš€ Deploy Enspirion Dashboard

# Trigger deployment on push to main or manual trigger
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Set permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

# Environment variables
env:
  NODE_VERSION: '18'
  CACHE_KEY: 'enspirion-dashboard-v2'

jobs:
  # ================================
  # QUALITY ASSURANCE & TESTING
  # ================================
  test:
    name: ğŸ§ª Test & Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸ§¹ ESLint Check
        run: npm run lint
        
      - name: ğŸ¨ Prettier Check
        run: npm run format:check
        
      - name: ğŸ§ª Run Unit Tests
        run: npm run test:ci
        
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        if: success()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          
  # ================================
  # SECURITY SCANNING
  # ================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸ” NPM Security Audit
        run: npm run security-audit
        continue-on-error: true
        
      - name: ğŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
          
      - name: ğŸ›¡ï¸ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        
  # ================================
  # BUILD APPLICATION
  # ================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build for Production
        run: npm run build:production
        env:
          NODE_ENV: production
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_BUILD_DATE: ${{ github.event.head_commit.timestamp }}
          VITE_DEPLOYMENT_TARGET: ${{ github.event.inputs.environment || 'production' }}
          
      - name: ğŸ“Š Bundle Size Analysis
        run: npm run bundle-analyze
        continue-on-error: true
        
      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 7
          
      - name: ğŸ“„ Upload Bundle Analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: dist/bundle-report.html
          retention-days: 7
          if-no-files-found: ignore
          
  # ================================
  # LIGHTHOUSE PERFORMANCE AUDIT
  # ================================
  lighthouse:
    name: ğŸ® Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸš€ Start Preview Server
        run: |
          npm run serve &
          sleep 10
          
      - name: ğŸ® Run Lighthouse CI
        run: npm run lighthouse:ci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: ğŸ“Š Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 7
          
  # ================================
  # DEPLOY TO GITHUB PAGES
  # ================================
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, lighthouse]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/
          
      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¦ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ğŸ“Š Post-Deploy Health Check
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          
          # Health check
          HEALTH_CHECK_URL="${{ steps.deployment.outputs.page_url }}"
          
          echo "Checking deployment health at: $HEALTH_CHECK_URL"
          
          # Simple curl check
          if curl -f -s "$HEALTH_CHECK_URL" > /dev/null; then
            echo "âœ… Deployment health check passed"
          else
            echo "âŒ Deployment health check failed"
            exit 1
          fi
          
  # ================================
  # POST-DEPLOYMENT TASKS
  # ================================
  post-deploy:
    name: ğŸ“Š Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Update Deployment Status
        run: |
          echo "Deployment completed successfully!"
          echo "URL: ${{ needs.deploy.outputs.url || 'https://enspirion.github.io/energy-dashboard/' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          
      - name: ğŸ“ Create Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸš€ Deployment Summary
          
          | Field | Value |
          |-------|-------|
          | **Status** | âœ… Success |
          | **Environment** | ${{ github.event.inputs.environment || 'production' }} |
          | **URL** | [${{ needs.deploy.outputs.url || 'https://enspirion.github.io/energy-dashboard/' }}](${{ needs.deploy.outputs.url || 'https://enspirion.github.io/energy-dashboard/' }}) |
          | **Commit** | [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          | **Author** | ${{ github.actor }} |
          | **Triggered by** | ${{ github.event_name }} |
          | **Build time** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |
          
          ### ğŸ“Š Build Artifacts
          - Build files uploaded to GitHub Pages
          - Lighthouse performance audit completed
          - Security scan passed
          - Bundle analysis available in artifacts
          
          ### ğŸ”— Quick Links
          - [ğŸ“Š Dashboard](${{ needs.deploy.outputs.url || 'https://enspirion.github.io/energy-dashboard/' }})
          - [ğŸ“ˆ Performance Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ”§ Repository](https://github.com/${{ github.repository }})
          EOF
          
  # ================================
  # NOTIFICATION ON FAILURE
  # ================================
  notify-failure:
    name: ğŸ“§ Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, security, build, lighthouse, deploy]
    if: failure()
    
    steps:
      - name: ğŸ“§ Create Failure Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âŒ Deployment Failed
          
          | Field | Value |
          |-------|-------|
          | **Status** | âŒ Failed |
          | **Commit** | [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          | **Author** | ${{ github.actor }} |
          | **Triggered by** | ${{ github.event_name }} |
          | **Failed at** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |
          
          ### ğŸ” Debug Information
          - Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
          - Review the failing job outputs above
          - Verify all secrets and environment variables are properly set
          
          ### ğŸ› ï¸ Common Solutions
          1. **Test failures**: Check test output and fix failing tests
          2. **Security issues**: Review security audit results and fix vulnerabilities
          3. **Build failures**: Check build logs for missing dependencies or configuration issues
          4. **Deployment issues**: Verify GitHub Pages settings and permissions
          EOF

# ================================
# ADDITIONAL WORKFLOWS
# ================================
---
name: ğŸ”„ Auto-Update Dependencies

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM UTC
  workflow_dispatch:

jobs:
  update-deps:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ” Check for Updates
        id: updates
        run: |
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“ Create Update PR
        if: steps.updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“¦ chore: update dependencies'
          title: 'ğŸ“¦ Automated dependency updates'
          body: |
            ## ğŸ“¦ Automated Dependency Updates
            
            This PR contains automated dependency updates generated by GitHub Actions.
            
            ### ğŸ” Changes
            - Updated outdated npm packages to their latest versions
            - Security patches applied automatically
            - No breaking changes expected
            
            ### ğŸ§ª Validation
            - [ ] Automated tests pass
            - [ ] Manual testing completed
            - [ ] No breaking changes identified
            
            ### ğŸ“‹ Review Checklist
            - [ ] Review package changes
            - [ ] Test critical functionality
            - [ ] Check for any deprecation warnings
            
            *This PR was created automatically. Please review carefully before merging.*
            
          branch: automated/dependency-updates
          delete-branch: true

---
name: ğŸ›¡ï¸ Security Scan

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ” Daily Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸ” NPM Audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ›¡ï¸ CodeQL Scan
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
          
      - name: ğŸ›¡ï¸ Perform Analysis
        uses: github/codeql-action/analyze@v2